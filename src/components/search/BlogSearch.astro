---
const { apiPath = '/api/v1/search/search-blog' } = Astro.props;
---
<style is:global>
  [x-cloak]{display:none!important}
</style>

<div
  x-data="blogSearchComponent()"
  x-init="init($el)"
  data-api={apiPath}
  @keydown.escape="close()"
  class="relative w-full max-w-2xl"
>
  <form @submit.prevent="goToFirst()" class="relative">
    <label class="input input-bordered w-full flex items-center gap-2 pr-10 pl-10">
      <svg class="w-5 h-5 opacity-60 pointer-events-none absolute left-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z"/>
      </svg>

      <input
        type="text"
        class="grow bg-transparent outline-none"
        x-model="q"
        @focus="open = true"
        placeholder="Search articles..."
        aria-label="Search blog articles"
        autocomplete="off"
      />

      <button class="btn btn-circle btn-ghost btn-xs absolute right-2" type="button" x-show="q.length" @click="clear()" aria-label="Clear search">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path stroke-linecap="round" d="M6 6l12 12M18 6L6 18"/>
        </svg>
      </button>

      <svg x-show="loading" class="animate-spin absolute right-12 w-5 h-5 opacity-60" viewBox="0 0 24 24" aria-hidden="true">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" opacity=".25"></circle>
        <path d="M4 12a8 8 0 0 1 8-8" stroke="currentColor" stroke-width="4" fill="none" stroke-linecap="round"></path>
      </svg>
    </label>
  </form>

  <div
    x-cloak
    x-show="open"
    @click.away="close()"
    class="absolute z-50 mt-2 w-full overflow-hidden rounded-2xl border border-base-200 bg-base-100 shadow-xl"
  >
    <div x-show="!loading && results.length === 0 && q.length > 0" class="p-4 text-sm text-base-content/70">
      No matches for <span class="font-medium" x-text="q"></span>.
    </div>

    <ul class="menu menu-sm" x-show="results.length > 0">
      <template x-for="item in results.slice(0, limit)" :key="item.slug">
        <li>
          <a class="py-3 px-4 flex items-center gap-3 hover:bg-base-200" :href="`/blog/${item.slug}`" @click="close()">
            <svg class="w-4 h-4 opacity-60" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z"/>
            </svg>
            <span class="truncate" x-text="item.title"></span>
          </a>
        </li>
      </template>
    </ul>
  </div>
</div>

<script is:inline>
  function debounce(fn, wait=250){let t;return function(...a){clearTimeout(t);t=setTimeout(()=>fn.apply(this,a),wait)}}

  function blogSearchComponent() {
    return {
      apiPath: '/api/v1/search/search-blog',
      q: '',
      results: [],
      loading: false,
      open: false,
      limit: 10,

      init(root) {
        const p = root.getAttribute('data-api');
        if (p) this.apiPath = p;

        this.$watch('q', debounce((val) => {
          const term = (val || '').trim();
          if (!term) { this.results = []; this.open = false; return; }
          this.search(term);
        }, 250));
      },

      async search(term) {
        this.loading = true;
        try {
          const res = await fetch(`${this.apiPath}?q=${encodeURIComponent(term)}`, { cache: 'no-store' });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          this.results = await res.json();
          this.open = true;
        } catch (e) {
          console.error('Search failed:', e);
          this.results = [];
        } finally {
          this.loading = false;
        }
      },

      clear() { this.q = ''; this.results = []; this.open = false; },
      close() { this.open = false; },
      goToFirst() { if (this.results.length > 0) window.location.href = `/blog/${this.results[0].slug}`; },
    }
  }
</script>


