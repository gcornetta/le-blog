---
/**
 * PostCard.astro — compact card for non-main articles (frontmatter: main = false)
 * Order: Image → Title → Meta (avatar+author+date) → Excerpt → CTA
 */

import { Image } from "astro:assets";
import { computePostMetadata } from "../../utils/content/postMetadata.mjs";

const { post } = Astro.props;

// Normalize frontmatter
const fm = "data" in post ? post.data : post;
const slug = post.slug;

// Accept ImageMetadata or remote URL
const heroObj =
  (typeof fm.heroImage === "object" && fm.heroImage?.src ? fm.heroImage : undefined);
const heroUrl =
  (typeof fm.heroImage === "string" && /^https?:\/\//i.test(fm.heroImage) ? fm.heroImage : undefined);

const avatarObj =
  (typeof fm.avatarImage === "object" && fm.avatarImage?.src ? fm.avatarImage : undefined);
const avatarUrl =
  (typeof fm.avatarImage === "string" && /^https?:\/\//i.test(fm.avatarImage) ? fm.avatarImage : undefined);

// Meta
const { excerpt } = computePostMetadata(post.body ?? "");

// Date formatting
const dateObj = new Date(fm.pubDate);
const formattedDate = isNaN(dateObj.getTime())
  ? String(fm.pubDate)
  : dateObj.toLocaleDateString("en-US", { year: "numeric", month: "short", day: "2-digit" });
const dateISO = isNaN(dateObj.getTime()) ? undefined : dateObj.toISOString();
---

<article
  class="card bg-base-100 border border-base-200/60 rounded-2xl shadow-lg hover:shadow-xl
         transition-all duration-300 ease-out overflow-hidden h-full flex flex-col"
  style="content-visibility:auto; contain-intrinsic-size:480px"
>
  <div class="card-body gap-4 p-6 grow">

    <!-- Image (16:9, stable height) -->
    {(heroObj || heroUrl) && (
      <div class="hero-box relative aspect-[16/9] overflow-hidden rounded-xl">
        {heroObj ? (
          <Image
            src={heroObj}
            alt={fm.title}
            class="block transition-transform duration-300 ease-out hover:scale-[1.02]"
            loading="lazy"
            decoding="async"
            sizes="(min-width:1024px) 33vw, (min-width:768px) 50vw, 100vw"
            widths={[480, 768, 1024, 1280]}
          />
        ) : (
          <img
            src={heroUrl}
            alt={fm.title}
            class="block w-full h-full object-cover transition-transform duration-300 ease-out hover:scale-[1.02]"
            loading="lazy"
            width="800"
            height="450"
          />
        )}
      </div>
    )}

    <!-- Title (below image) -->
    <h3
      class="text-xl font-semibold leading-tight tracking-tight text-balance
             hover:underline underline-offset-4"
    >
      <a href={`/blog/${slug}`} class="link link-hover">{fm.title}</a>
    </h3>

    <!-- Meta: avatar + author + date -->
    <div class="flex items-center gap-3 text-sm text-base-content/70 flex-wrap">
      <!-- Avatar -->
      <div class="shrink-0">
        <div class="w-9 h-9 rounded-full ring-2 ring-primary ring-offset-2 ring-offset-base-100 bg-base-100 p-0.5">
          {avatarObj ? (
            <Image
              src={avatarObj}
              alt={fm.author}
              width={36}
              height={36}
              loading="lazy"
              decoding="async"
              class="w-full h-full rounded-full object-contain"
            />
          ) : avatarUrl ? (
            <img
              src={avatarUrl}
              alt={fm.author}
              width="36"
              height="36"
              loading="lazy"
              class="w-full h-full rounded-full object-contain"
            />
          ) : null}
        </div>
      </div>

      <!-- Author -->
      {fm.author && (
        <span class="whitespace-nowrap">
          By <span class="font-medium">{fm.author}</span>
        </span>
      )}

      <!-- Date -->
      <span class="flex items-center gap-1 whitespace-nowrap">
        <svg class="w-4 h-4 text-base-content/50" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        {dateISO ? <time datetime={dateISO}>{formattedDate}</time> : <span>{formattedDate}</span>}
      </span>
    </div>

    <!-- Excerpt -->
    <div class="relative border-l-4 border-primary pl-4 text-sm text-base-content/80 italic">
      <div class="flex gap-2 items-start">
        <svg class="w-5 h-5 text-primary mt-1 flex-shrink-0" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
          <path d="M7 10.4142L2.70711 14.7071L1.29289 13.2929L5 9.58579V9L1 9V2H7V10.4142Z"/>
          <path d="M9 9L13 9V9.58579L9.29289 13.2929L10.7071 14.7071L15 10.4142L15 2H9L9 9Z"/>
        </svg>
        <p class="line-clamp-3">{excerpt}</p>
      </div>
    </div>

    <!-- CTA pinned to bottom of card -->
    <div class="mt-auto pt-2 border-t border-base-200 text-sm flex justify-end items-center">
      <div class="card-actions justify-end">
        <a
          href={`/blog/${slug}`}
          class="btn btn-ghost normal-case text-[0.91rem] md:text-[1.01rem] font-medium leading-tight px-3 md:px-4 py-2 gap-1"
        >
          Read More
          <svg xmlns="http://www.w3.org/2000/svg" class="ml-1 h-[15px] w-[15px] md:h-4 md:w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </a>
      </div>
    </div>

  </div>
</article>

<style>
  /* Make the <picture> generated by astro:assets fill the 16:9 box */
  .hero-box picture { position: absolute; inset: 0; width: 100%; height: 100%; }
  .hero-box img     { width: 100%; height: 100%; object-fit: cover; }
</style>
